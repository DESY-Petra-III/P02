import os

from PySide.QtNetwork import QSsl, QSslConfiguration, QSslCertificate
from PySide.QtCore import QFile, QIODevice

from PyQt4.QtCore import *
from PyQt4.QtGui import *
from PyQt4.QtNetwork import *


def load_certs(cert_path):
    # cert_path is a string "/path/to/cert/files"
    ssl_config = QSslConfiguration.defaultConfiguration()
    ssl_config.setProtocol(QSsl.SecureProtocols)

    certs = ssl_config.caCertificates()

    for cert_filename in os.listdir(cert_path):
        if os.path.splitext(cert_filename)[1] in ('.cer', '.crt', '.pem'):
            cert_filepath = os.path.join(cert_path, cert_filename)
            print("Loading cert: %s"%cert_filepath)
            cert_file = QFile(cert_filepath)
            cert_file.open(QIODevice.ReadOnly)
            cert = QSslCertificate(cert_file)
            certs.append(cert)

    ssl_config.setCaCertificates(certs)
    QSslConfiguration.setDefaultConfiguration(ssl_config)


app = QApplication([])

load_certs("./")

socket=QSslSocket()
socket.ignoreSslErrors()
socket.addCaCertificates("./")
# socket.addCaCertificates("/etc/pki/CA")
# socket.setLocalCertificate("/etc/pki/tls/cert.pem")

socket.connectToHostEncrypted("bugs.kde.org", 443 );

if(not socket.waitForEncrypted()):
    print(socket.errorString())


socket.write( "GET / HTTP/1.1\r\n"+
              "Host: bugs.kde.org\r\n"+
              "Connection: Close\r\n\r\n" );